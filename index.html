<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç´„É≥„Éê„É≥„Éú„Éº„Éâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-900">
    <div id="app"></div>
    
    <script>
        // ========== Part 1: Ë®≠ÂÆö„Å®Áä∂ÊÖãÁÆ°ÁêÜ ==========
        const CONFIG = {
            CLIENT_ID: '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets',
            PARENT_FOLDER_NAME: '10_WSB-APP',
            TODO_FOLDER_NAME: 'ToDo„É™„Çπ„Éà',
            JSON_FILE_NAME: 'kanban_data.json',
            SPREADSHEET_ID: '1YPV5vgH4YqluO4929Pwl3QOoLrkWX0gsSLMS7osEY5E',
            APP_VERSION: '250118-1310'
        };

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let fileId = null;

        let state = {
            groups: [
                { id: 'group1', title: 'Todo', color: 'bg-gray-700', row: 0, items: [
                    { id: '1', content: 'Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ºÅÁîªÊõ∏„Çí‰ΩúÊàê', completed: false, memo: '' }
                ]},
                { id: 'group2', title: 'ÈÄ≤Ë°å‰∏≠', color: 'bg-green-800', row: 0, items: [] },
                { id: 'group3', title: 'ÂÆå‰∫Ü', color: 'bg-purple-800', row: 0, items: [] }
            ],
            draggedItem: null,
            draggedFrom: null,
            draggedGroup: null,
            newTaskGroup: null,
            newTaskContent: '',
            newGroupName: '',
            isAddingGroup: false,
            editingGroupId: null,
            editingGroupName: '',
            selectedTaskId: null,
            selectedTaskGroupId: null,
            isSignedIn: false,
            isSaving: false,
            folderId: null,
            lastUpdated: null
        };

        // ========== Google APIÂàùÊúüÂåñ ==========
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ]
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: ''
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) tryAutoSignIn();
        }

        // ========== Ë™çË®ºÈñ¢ÈÄ£ ==========
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                accessToken = gapi.client.getToken().access_token;
                state.isSignedIn = true;
                localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
                await loadFromDrive();
                render();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function tryAutoSignIn() {
            const savedToken = localStorage.getItem('google_access_token');
            if (savedToken) {
                try {
                    const token = JSON.parse(savedToken);
                    gapi.client.setToken(token);
                    accessToken = token.access_token;
                    await gapi.client.drive.files.list({ pageSize: 1 });
                    state.isSignedIn = true;
                    await loadFromDrive();
                } catch (error) {
                    localStorage.removeItem('google_access_token');
                }
            }
            render();
        }

        function handleSignOut() {
            gapi.client.setToken(null);
            localStorage.removeItem('google_access_token');
            accessToken = null;
            state.isSignedIn = false;
            state.folderId = null;
            fileId = null;
            render();
            showMessage('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
        });

        // Google DriveÊé•Á∂ö
        async function loadFromDrive() {
            try {
                let parentFolderId = await findOrCreateFolder(CONFIG.PARENT_FOLDER_NAME, 'root');
                let todoFolderId = await findOrCreateFolder(CONFIG.TODO_FOLDER_NAME, parentFolderId);
                state.folderId = todoFolderId;
                await loadJsonData();
                showMessage('Google Drive„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                showMessage('„Ç®„É©„Éº: ' + (error.result?.error?.message || error.message), 'error');
            }
        }
        
        // „Éï„Ç©„É´„ÉÄÊ§úÁ¥¢„Åæ„Åü„ÅØ‰ΩúÊàê
        async function findOrCreateFolder(folderName, parentId) {
            const response = await gapi.client.drive.files.list({
                q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and '${parentId}' in parents and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });
            if (response.result.files && response.result.files.length > 0) {
                return response.result.files[0].id;
            }
            const createResponse = await gapi.client.drive.files.create({
                resource: {
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [parentId]
                },
                fields: 'id'
            });
            return createResponse.result.id;
        }
        
        // JSON„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadJsonData() {
            if (!state.folderId) return;
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${CONFIG.JSON_FILE_NAME}' and '${state.folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    fileId = files[0].id;
                    const fileContent = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });
                    if (fileContent.body) {
                        const data = JSON.parse(fileContent.body);
                        state.groups = data.groups || state.groups;
                        state.lastUpdated = data.lastUpdated || null;
                    }
                } else {
                    fileId = null;
                }
            } catch (error) {
                fileId = null;
            }
        }
        
        // Google Drive„Å´‰øùÂ≠ò
        async function saveToDrive() {
            if (!state.isSignedIn || !state.folderId || state.isSaving) return;
            state.isSaving = true;
            render();
            try {
                const now = new Date().toISOString();
                const content = JSON.stringify({ groups: state.groups, lastUpdated: now });
                const file = new Blob([content], { type: 'application/json' });
                const metadata = {
                    name: CONFIG.JSON_FILE_NAME,
                    mimeType: 'application/json',
                    ...(fileId ? {} : { parents: [state.folderId] })
                };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                const url = fileId
                    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
                    : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;
                const response = await fetch(url, {
                    method: fileId ? 'PATCH' : 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
                if (!response.ok) throw new Error(`‰øùÂ≠ò„Å´Â§±Êïó: ${response.status}`);
                const result = await response.json();
                if (!fileId) fileId = result.id;
                state.lastUpdated = now;
                showMessage('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            } catch (error) {
                showMessage('‰øùÂ≠ò„Å´Â§±Êïó: ' + error.message, 'error');
            } finally {
                state.isSaving = false;
                render();
            }
        }
        
        // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂêåÊúü
        async function exportToSpreadsheet() {
            if (!state.isSignedIn) {
                showMessage('ÂÖà„Å´Google Drive„Å´Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            try {
                showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Êõ∏„ÅçËæº„Åø‰∏≠...', 'success');
                const headers = [['„Ç∞„É´„Éº„ÉóÂêç', 'Ë°å', '„Çø„Çπ„ÇØÂÜÖÂÆπ', 'ÂÆå‰∫ÜÁä∂ÊÖã', 'ÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ']];
                const rows = [];
                state.groups.forEach(group => {
                    group.items.forEach(item => {
                        rows.push([
                            group.title,
                            `${group.row + 1}Ë°åÁõÆ`,
                            item.content,
                            item.completed ? '‚úì' : '',
                            new Date().toLocaleString('ja-JP')
                        ]);
                    });
                });
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: '„Ç∑„Éº„Éà1!A1:Z'
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: '„Ç∑„Éº„Éà1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [...headers, ...rows] }
                });
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            repeatCell: {
                                range: { sheetId: 0, startRowIndex: 0, endRowIndex: 1 },
                                cell: { userEnteredFormat: { textFormat: { bold: true }}},
                                fields: 'userEnteredFormat.textFormat.bold'
                            }
                        }]
                    }
                });
                window.open(`https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}`, '_blank');
                showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Êõ∏„ÅçËæº„Åø„Åæ„Åó„ÅüÔºÅ', 'success');
            } catch (error) {
                showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊõ∏„ÅçËæº„ÅøÂ§±Êïó: ' + (error.result?.error?.message || error.message), 'error');
            }
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó: „Çø„Çπ„ÇØÈñãÂßã
        function handleTaskDragStart(e, item, groupId) {
            state.draggedItem = item;
            state.draggedFrom = groupId;
            e.dataTransfer.effectAllowed = 'move';
            e.stopPropagation();
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó: „Ç∞„É´„Éº„ÉóÈñãÂßã
        function handleGroupDragStart(e, groupId) {
            state.draggedGroup = groupId;
            e.dataTransfer.effectAllowed = 'move';
        }
        
        // „Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        // „Éâ„É≠„ÉÉ„Éó: „Çø„Çπ„ÇØ
        async function handleTaskDrop(e, targetGroupId, targetIndex = null) {
            e.preventDefault();
            e.stopPropagation();
            if (!state.draggedItem || !state.draggedFrom) return;
            
            // ÂÖÉ„ÅÆ„Ç∞„É´„Éº„Éó„Åã„ÇâÂâäÈô§
            state.groups = state.groups.map(group => {
                if (group.id === state.draggedFrom) {
                    return { ...group, items: group.items.filter(item => item.id !== state.draggedItem.id) };
                }
                return group;
            });
            
            // „Çø„Éº„Ç≤„ÉÉ„Éà„Ç∞„É´„Éº„Éó„Å´ËøΩÂä†
            state.groups = state.groups.map(group => {
                if (group.id === targetGroupId) {
                    const newItems = [...group.items];
                    if (targetIndex !== null && targetIndex >= 0) {
                        // ÁâπÂÆö„ÅÆ‰ΩçÁΩÆ„Å´ÊåøÂÖ•
                        newItems.splice(targetIndex, 0, state.draggedItem);
                    } else {
                        // Êú´Â∞æ„Å´ËøΩÂä†
                        newItems.push(state.draggedItem);
                    }
                    return { ...group, items: newItems };
                }
                return group;
            });
            
            state.draggedItem = null;
            state.draggedFrom = null;
            await saveToDrive();
            render();
        }
        
        // „Éâ„É≠„ÉÉ„Éó: „Ç∞„É´„Éº„Éó
        async function handleGroupDrop(e, targetRow, targetIndex) {
            e.preventDefault();
            if (!state.draggedGroup) return;
            const draggedGroupData = state.groups.find(g => g.id === state.draggedGroup);
            const otherGroups = state.groups.filter(g => g.id !== state.draggedGroup);
            const targetRowGroups = otherGroups.filter(g => g.row === targetRow);
            targetRowGroups.splice(targetIndex, 0, { ...draggedGroupData, row: targetRow });
            const otherRowGroups = otherGroups.filter(g => g.row !== targetRow);
            state.groups = [...otherRowGroups, ...targetRowGroups];
            state.draggedGroup = null;
            await saveToDrive();
            render();
        }
        
        // „Çø„Çπ„ÇØËøΩÂä†
        async function addTask(groupId) {
            if (!state.newTaskContent.trim()) return;
            const newTask = { 
                id: Date.now().toString(), 
                content: state.newTaskContent, 
                completed: false,
                memo: ''
            };
            state.groups = state.groups.map(group => 
                group.id === groupId ? { ...group, items: [...group.items, newTask] } : group
            );
            state.newTaskContent = '';
            state.newTaskGroup = null;
            await saveToDrive();
            render();
        }
        
        // „Ç∞„É´„Éº„ÉóËøΩÂä†
        async function addGroup() {
            if (!state.newGroupName.trim()) return;
            const colors = ['bg-blue-800', 'bg-red-800', 'bg-indigo-800', 'bg-pink-800', 'bg-teal-800'];
            const newGroup = {
                id: Date.now().toString(),
                title: state.newGroupName,
                color: colors[Math.floor(Math.random() * colors.length)],
                row: 0,
                items: []
            };
            state.groups = [...state.groups, newGroup];
            state.newGroupName = '';
            state.isAddingGroup = false;
            await saveToDrive();
            render();
        }
        
        // „Çø„Çπ„ÇØÂâäÈô§ÔºàÂÆåÂÖ®ÂâäÈô§Ôºâ
        async function deleteTask(groupId, taskId) {
            if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            state.groups = state.groups.map(group => {
                if (group.id === groupId) {
                    return { ...group, items: group.items.filter(item => item.id !== taskId) };
                }
                return group;
            });
            await saveToDrive();
            render();
        }
        
        // „Çø„Çπ„ÇØÂÆå‰∫Ü„Éà„Ç∞„É´
        async function toggleComplete(groupId, taskId) {
            const item = state.groups.find(g => g.id === groupId)?.items.find(i => i.id === taskId);
            if (!item) return;
            
            // ÂÆå‰∫ÜÁä∂ÊÖã„Çí„Éà„Ç∞„É´
            const updatedItem = { ...item, completed: !item.completed };
            
            // ÂÆå‰∫Ü„Åô„ÇãÂ†¥Âêà„ÅØÂÖÉ„ÅÆ„Ç∞„É´„Éº„ÉóID„Çí‰øùÂ≠ò
            if (updatedItem.completed && !updatedItem.originalGroupId) {
                updatedItem.originalGroupId = groupId;
            }
            
            // ÂÖÉ„ÅÆ„Ç∞„É´„Éº„Éó„Åã„ÇâÂâäÈô§
            state.groups = state.groups.map(group => {
                if (group.id === groupId) {
                    return { ...group, items: group.items.filter(i => i.id !== taskId) };
                }
                return group;
            });
            
            // ÂÆå‰∫ÜÁä∂ÊÖã„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å™„Ç∞„É´„Éº„Éó„Å´ËøΩÂä†
            let targetGroupId;
            if (updatedItem.completed) {
                targetGroupId = 'group3'; // ÂÆå‰∫Ü„Ç∞„É´„Éº„Éó„Å∏
            } else {
                targetGroupId = updatedItem.originalGroupId || 'group1'; // ÂÖÉ„ÅÆ„Ç∞„É´„Éº„Éó„Åæ„Åü„ÅØTodo„Å∏
                delete updatedItem.originalGroupId; // ÂÆå‰∫ÜËß£Èô§ÊôÇ„ÅØÂÖÉ„Ç∞„É´„Éº„ÉóID„ÇíÂâäÈô§
            }
            
            state.groups = state.groups.map(group => {
                if (group.id === targetGroupId) {
                    return { ...group, items: [...group.items, updatedItem] };
                }
                return group;
            });
            
            await saveToDrive();
            render();
        }
        
        // „Ç∞„É´„Éº„ÉóÂâäÈô§
        async function deleteGroup(groupId) {
            if (confirm('„Åì„ÅÆ„Ç∞„É´„Éº„Éó„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‰∏≠„ÅÆ„Çø„Çπ„ÇØ„ÇÇ„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                state.groups = state.groups.filter(group => group.id !== groupId);
                await saveToDrive();
                render();
            }
        }
        
        // „Ç∞„É´„Éº„ÉóÂêçÁ∑®ÈõÜÈñãÂßã
        function startEditGroupName(groupId) {
            const group = state.groups.find(g => g.id === groupId);
            if (group) {
                state.editingGroupId = groupId;
                state.editingGroupName = group.title;
                render();
                setTimeout(() => {
                    const input = document.getElementById(`group-name-input-${groupId}`);
                    if (input) { 
                        input.focus(); 
                        input.select(); 
                    }
                }, 0);
            }
        }
        
        // „Ç∞„É´„Éº„ÉóÂêç‰øùÂ≠ò
        async function saveGroupName(groupId) {
            if (!state.editingGroupName.trim()) {
                cancelEditGroupName();
                return;
            }
            state.groups = state.groups.map(group =>
                group.id === groupId ? { ...group, title: state.editingGroupName } : group
            );
            state.editingGroupId = null;
            state.editingGroupName = '';
            await saveToDrive();
            render();
        }
        
        // „Ç∞„É´„Éº„ÉóÂêçÁ∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEditGroupName() {
            state.editingGroupId = null;
            state.editingGroupName = '';
            render();
        }

        // „Çø„Çπ„ÇØÈÅ∏Êäû
        function selectTask(groupId, taskId) {
            state.selectedTaskId = taskId;
            state.selectedTaskGroupId = groupId;
            render();
            setTimeout(() => {
                const input = document.getElementById('selected-task-name-input');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 0);
        }
        
        // „Çø„Çπ„ÇØÈÅ∏ÊäûËß£Èô§
        function deselectTask() {
            state.selectedTaskId = null;
            state.selectedTaskGroupId = null;
            render();
        }
        
        // „Çø„Çπ„ÇØÁ∑®ÈõÜÁî®„ÅÆËá™Âãï‰øùÂ≠òÈÅÖÂª∂
        const AUTO_SAVE_DELAY = 2000;
        let debouncedSaveTimer = null;
        let isTaskNameComposing = false;

        function scheduleDebouncedSave() {
            if (debouncedSaveTimer) {
                clearTimeout(debouncedSaveTimer);
            }

            debouncedSaveTimer = setTimeout(async function attemptSave() {
                if (isTaskNameComposing) {
                    debouncedSaveTimer = setTimeout(attemptSave, 200);
                    return;
                }

                if (state.isSaving) {
                    debouncedSaveTimer = setTimeout(attemptSave, 500);
                    return;
                }

                debouncedSaveTimer = null;
                await saveToDrive();
            }, AUTO_SAVE_DELAY);
        }

        // „Çø„Çπ„ÇØÂÜÖÂÆπ‰øùÂ≠ò
            function saveTaskContent(groupId, taskId, newContent) {
                if (!newContent.trim()) return;
                
                state.groups = state.groups.map(group =>
                    group.id === groupId
                        ? {
                            ...group,
                            items: group.items.map(item =>
                                item.id === taskId ? { ...item, content: newContent } : item
                            )
                        }
                        : group
                );
                
                scheduleDebouncedSave();
            }
        
        // „É°„É¢‰øùÂ≠òÁî®„ÅÆ„Çø„Ç§„Éû„Éº
        let memoSaveTimer = null;
        

        function handleTaskNameInput(event, groupId, taskId, input) {
            if ((event && event.isComposing) || isTaskNameComposing) {
                return;
            }

            saveTaskContent(groupId, taskId, input.value);
        }

        function handleTaskNameCompositionStart() {
            isTaskNameComposing = true;
        }

        function handleTaskNameCompositionEnd(groupId, taskId, input) {
            isTaskNameComposing = false;
            saveTaskContent(groupId, taskId, input.value);
        }

        // „Çø„Çπ„ÇØ„É°„É¢‰øùÂ≠ò(ÈÅÖÂª∂‰øùÂ≠ò)
        function saveTaskMemo(groupId, taskId, newMemo) {
            // Âç≥Â∫ß„Å´state„ÇíÊõ¥Êñ∞
            state.groups = state.groups.map(group =>
                group.id === groupId
                    ? {
                        ...group,
                        items: group.items.map(item =>
                            item.id === taskId ? { ...item, memo: newMemo } : item
                        )
                    }
                    : group
            );
            
            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
            if (memoSaveTimer) {
                clearTimeout(memoSaveTimer);
            }
            scheduleDebouncedSave();
        }

        function adjustMemoTextareaHeight(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            const computedStyle = window.getComputedStyle(textarea);
            const minHeight = parseFloat(computedStyle.minHeight) || 0;
            const maxHeight = parseFloat(computedStyle.maxHeight);
            const scrollHeight = textarea.scrollHeight;
            let targetHeight = Math.max(scrollHeight, minHeight);
            if (maxHeight && !Number.isNaN(maxHeight)) {
                targetHeight = Math.min(targetHeight, maxHeight);
                textarea.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden';
            } else {
                textarea.style.overflowY = 'hidden';
            }
            
            // 2ÁßíÂæå„Å´‰øùÂ≠ò
            memoSaveTimer = setTimeout(async () => {
                await saveToDrive();
            }, 2000);
            textarea.style.height = `${targetHeight}px`;
        }

        function handleMemoInput(groupId, taskId, textarea) {
            adjustMemoTextareaHeight(textarea);
            saveTaskMemo(groupId, taskId, textarea.value);
        }
        
        // „Çø„Çπ„ÇØÁ∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEditTask() {
            state.editingTaskId = null;
            state.editingTaskGroupId = null;
            render();
        }

        function render() {
            const row0Groups = state.groups.filter(g => g.row === 0);
            const row1Groups = state.groups.filter(g => g.row === 1);
            
            const selectedTask = state.selectedTaskId 
                ? state.groups.find(g => g.id === state.selectedTaskGroupId)?.items.find(i => i.id === state.selectedTaskId)
                : null;
        
            const renderGroup = (group, index, row) => {
                const isEditing = state.editingGroupId === group.id;
                return `
                    <div class="flex-shrink-0 w-80 relative" draggable="true" 
                         onDragStart="handleGroupDragStart(event, '${group.id}')" 
                         onDragOver="handleDragOver(event)"
                         onDrop="handleGroupDrop(event, ${row}, ${index})">
                        <div class="absolute inset-y-0 left-0 w-2 z-10 pointer-events-auto" 
                             onDragOver="handleDragOver(event)"
                             onDrop="handleGroupDrop(event, ${row}, ${index})"></div>
                        <div class="absolute inset-y-0 right-0 w-2 z-10 pointer-events-auto" 
                             onDragOver="handleDragOver(event)"
@@ -725,87 +795,99 @@
                                        class="flex-shrink-0 w-80 h-12 bg-gray-800 hover:bg-gray-750 rounded-lg flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    „Ç∞„É´„Éº„Éó„ÇíËøΩÂä†
                                </button>
                            `}
                        </div>
                        
                    </div>
                    
                    ${selectedTask ? `
                    <!-- Âè≥ÂÅ¥Á∑®ÈõÜ„Éë„Éç„É´ -->
                    <div class="fixed top-4 right-4 w-96 z-50">
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-2xl flex flex-col" style="max-height: calc(100vh - 300px);">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-semibold">„Çø„Çπ„ÇØÁ∑®ÈõÜ</h3>
                                <button onclick="deselectTask()" class="text-gray-400 hover:text-white transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            
                            <div class="flex flex-col gap-4 flex-1 overflow-hidden">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">„Çø„Çπ„ÇØÂêç</label>
                                    <input id="selected-task-name-input" type="text" value="${selectedTask.content}" 
                                           oninput="saveTaskContent('${state.selectedTaskGroupId}', '${state.selectedTaskId}', this.value)"
                                    <input id="selected-task-name-input" type="text" value="${selectedTask.content}"
                                           oninput="handleTaskNameInput(event, '${state.selectedTaskGroupId}', '${state.selectedTaskId}', this)"
                                           oncompositionstart="handleTaskNameCompositionStart()"
                                           oncompositionend="handleTaskNameCompositionEnd('${state.selectedTaskGroupId}', '${state.selectedTaskId}', this)"
                                           class="w-full px-3 py-2 bg-gray-700 text-white text-sm rounded focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                </div>
                                
                                <div class="flex flex-col flex-1 overflow-hidden">
                                    <label class="block text-gray-400 text-xs mb-1">„É°„É¢</label>
                                    <textarea 
                                           oninput="saveTaskMemo('${state.selectedTaskGroupId}', '${state.selectedTaskId}', this.value)"
                                    <textarea
                                           id="task-memo-textarea"
                                           oninput="handleMemoInput('${state.selectedTaskGroupId}', '${state.selectedTaskId}', this)"
                                           onfocus="adjustMemoTextareaHeight(this)"
                                           placeholder="„É°„É¢„ÇíÂÖ•Âäõ..."
                                           class="flex-1 w-full px-3 py-2 bg-gray-700 text-white text-sm rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">${selectedTask.memo || ''}</textarea>
                                           style="max-height: calc(100vh - 300px);"
                                           class="w-full min-h-[120px] px-3 py-2 bg-gray-700 text-white text-sm rounded focus:outline-none focus:ring-2 focus:ring-blue-500">${selectedTask.memo || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Âè≥‰∏ãÂõ∫ÂÆö„Éë„Éç„É´ -->
                    <div class="fixed bottom-4 right-4 bg-gray-800 rounded-lg shadow-xl p-3 border border-gray-700">
                        <div class="flex flex-col gap-2">
                            ${state.isSignedIn ? `
                                <button onclick="exportToSpreadsheet()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                    üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂêåÊúü
                                </button>
                                <div class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs text-center">
                                    ‚úÖ Êé•Á∂öÊ∏à
                                </div>
                                <button onclick="handleSignOut()" 
                                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-xs transition-colors">
                                    „É≠„Ç∞„Ç¢„Ç¶„Éà
                                </button>
                            ` : `
                                <button onclick="handleAuthClick()" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-semibold transition-colors shadow-lg text-xs whitespace-nowrap">
                                    üîó Google Drive„Å´Êé•Á∂ö
                                </button>
                            `}
                            <div class="text-xs text-gray-400 text-center pt-2 border-t border-gray-700">
                                ${state.lastUpdated ? `Êõ¥Êñ∞: ${formatDateTime(state.lastUpdated)}<br>` : ''}
                                v${CONFIG.APP_VERSION}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // „Çø„Çπ„ÇØÂÖ•ÂäõÊ¨Ñ„Å´Ëá™Âãï„Éï„Ç©„Éº„Ç´„Çπ
            if (state.newTaskGroup) {
                setTimeout(() => {
                    const input = document.getElementById(`new-task-input-${state.newTaskGroup}`);
                    if (input) {
                        input.focus();
                    }
                }, 0);
            }

            setTimeout(() => {
                const memoTextarea = document.getElementById('task-memo-textarea');
                if (memoTextarea) {
                    adjustMemoTextareaHeight(memoTextarea);
                }
            }, 0);
        }

    </script>

</body>
</html>
